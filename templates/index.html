<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<!-- 移动端基础适配 -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>本地对话 (流式)</title>
{% raw %}
<style>
/* 基础样式优化 */
body {
  margin: 0;
  padding-bottom: 140px;
  font-family: Arial, Helvetica, sans-serif;
  background: #f5f7fa;
  -webkit-font-smoothing: antialiased;
}

#history {
  padding: 15px;
  overflow-y: auto;
  max-height: calc(100vh - 140px);
}

.msg {
  max-width: 90%; /* 移动端适配 */
  padding: 10px 14px;
  border-radius: 8px;
  line-height: 1.55;
  word-break: break-word;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08); /* 视觉增强 */
  margin: 8px 0;
}

.user {
  background: #0084ff;
  color: #fff;
  margin-left: auto;
}

.bot {
  background: #e6e6e6;
  color: #111;
  margin-right: auto;
}

/* 聊天栏样式优化 */
#bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #fff;
  border-top: 1px solid #ddd;
  display: flex;
  flex-direction: column;
  gap: 10px;
  padding: 12px;
  z-index: 10;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1); /* 增强阴影 */
}

/* 输入框优化 */
#text-input {
  flex: 1;
  font-size: 18px;
  padding: 12px 14px;
  border: 1px solid #ccc;
  border-radius: 6px;
  min-height: 40px;
  overflow-y: auto;
  line-height: 1.5;
  word-break: break-word;
  white-space: pre-wrap;
  resize: none;
}

#text-input:empty::before {
  content: attr(placeholder);
  color: #aaa;
  pointer-events: none;
  display: block;
}

/* 按钮样式增强 */
button {
  touch-action: manipulation;
  -webkit-tap-highlight-color: rgba(0,0,0,0.1);
}

#send,
#newTopic {
  padding: 12px 18px;
  font-size: 16px;
  background-color: #007bff;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: background-color 0.2s ease;
  min-width: 80px;
}

#send:hover {
  background-color: #0056b3;
}

#send:disabled {
  background-color: #6c757d;
  cursor: not-allowed;
}

#bar button {
  width: 100%;
}

#newTopic {
  background: #fff;
  color: #000;
  margin-left: auto;
  border: 1px solid #ccc;
  border-radius: 6px;
  padding: 12px 18px;
  font-size: 16px;
}


/* 图片预览优化 */
#preview-container {
  position: relative;
  display: none;
  align-self: flex-start;
}

#preview-img {
  max-height: 120px;
  max-width: 120px;
  border: 1px solid #888;
  border-radius: 6px;
  display: block;
  cursor: pointer;
}

#remove-image-btn {
  position: absolute;
  top: -16px;
  right: -16px;
  background: rgba(220, 53, 69, 0.85);
  color: white;
  border: 2px solid white;
  border-radius: 50%;
  width: 32px;
  height: 32px;
  font-size: 20px;
  font-weight: bold;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  padding: 0;
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  z-index: 1;
  transition: background-color 0.2s ease, transform 0.15s ease;
}

#remove-image-btn:hover {
  background: rgba(200, 30, 45, 1);
  transform: scale(1.1);
}

/* 响应式布局 */
@media (min-width: 769px) {
  #bar {
    flex-direction: row;
    gap: 8px;
  }

  #text-input {
    min-height: 22px;
  }

  .msg {
    max-width: 70%;
  }

  #bar button {
    width: auto;
    min-width: 60px;
  }
}

pre {
  white-space: pre-wrap;
}

.thinking {
  color: #888;
  font-style: italic;
}
/* 移动端收起按钮样式 */
#toggleBar {
  display: none; /* 默认隐藏（桌面端不显示） */
  position: fixed;
  bottom: 140px; /* 初始位置在#bar上方 */
  left: 0;
  right: 0;
  z-index: 15;
  text-align: center;
}

.arrow-btn {
  width: 40px;
  height: 20px;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 6px 6px 0 0;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}

#bar.collapsed {
  transform: translateY(140px);
  opacity: 0;
  pointer-events: none;
  transition: transform 0.3s ease, opacity 0.3s ease;
}
#bar {
  opacity: 1;
  pointer-events: auto;
}


/* 移动端专属样式 */
@media (max-width: 768px) {
  #toggleBar {
    display: block;
  }
  #bar {
    transition: transform 0.3s ease;
  }
}

</style>
{% endraw %}

<body>
<div id="history"></div>
<div id="toggleBar">
  <button id="arrowBtn" class="arrow-down">&#9660;</button>
</div>
<div id="bar">
  <select id="modelSelect"></select>
  <input type="file" accept="image/*" id="pick" style="display:none">
  <button id="pickBtn">选择图片</button>
  <div id="text-input" contenteditable="true" placeholder="输入内容…（Shift+Enter换行/Enter发送）"></div>
  <label style="display: flex; align-items: center; gap: 5px;">
    <input type="checkbox" id="enableSearch" />
    联网搜索
  </label>
  <div id="preview-container">
    <img id="preview-img">
    <button id="remove-image-btn" title="移除图片">&times;</button>
  </div>
  <button id="send">发送</button>
  <button id="newTopic">新话题</button>
</div>

<div id="viewer" style="display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:999;align-items:center;justify-content:center;">
  <img id="viewerImg" style="max-width:95vw;max-height:95vh;border-radius:6px;box-shadow:0 0 12px #000">
</div>

<!-- 延迟加载marked.js -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const script = document.createElement('script');
  script.src = '/static/marked.min.js';
  script.onload = () => {
       // 定义 md2html 函数
       window.md2html = function(txt) {
         if (window.marked) {
           marked.setOptions({ gfm: true, breaks: true, html: true });
           return marked.parse(txt);
         }
         // 回退逻辑（纯文本渲染）
         return txt.replace(/&/g,"&amp;")
                  .replace(/</g,"&lt;")
                  .replace(/>/g,"&gt;")
                  .replace(/\n/g,"<br>");
       };
       // 标记加载完成状态
       window.markedReady = true;
       // 处理待解析内容
       if (window.pendingMd) {
         document.querySelectorAll('.msg').forEach(el => {
           if (el.dataset.pending) {
             el.innerHTML = md2html(el.dataset.content);
             delete el.dataset.pending;
           }
         });
       }
  };

  document.body.appendChild(script);
});
// 新增变量
let isBarCollapsed = false;

// 箭头按钮点击事件
document.getElementById('arrowBtn').addEventListener('click', () => {
  isBarCollapsed = !isBarCollapsed;
  if (isBarCollapsed) {
    // 收起操作栏 => 显示向上箭头 (▲)
    document.getElementById('bar').classList.add('collapsed');
    document.getElementById('arrowBtn').innerHTML = '&#9650;'; // 向上箭头
  } else {
    // 展开操作栏 => 显示向下箭头 (▼)
    document.getElementById('bar').classList.remove('collapsed');
    document.getElementById('arrowBtn').innerHTML = '&#9660;'; // 向下箭头
  }
});




</script>

<script>
const $ = id => document.getElementById(id);
const historyBox = $("history");
const textInput = $("text-input");
textInput.addEventListener('focus', () => {
  if (isBarCollapsed) {
    document.getElementById('arrowBtn').click();
  }
});

const previewContainer = $("preview-container");
const previewImage = $("preview-img");
const removeImageBtn = $("remove-image-btn");

let imageBase64 = null;
let imageLocalURL = null;
let currentEventSource = null;

async function loadHistory() {
  try {
    const r = await fetch('/history');
    if (!r.ok) throw new Error(`HTTP error! status: ${r.status}`);
    const arr = await r.json();
    historyBox.innerHTML = '';
    arr.forEach(obj => {
      appendMsg(obj.md, obj.who, false);
    });
    historyBox.scrollTop = historyBox.scrollHeight;
  } catch (error) {
    console.error("加载历史记录失败:", error);
    historyBox.innerHTML = '<div class="msg bot">加载历史记录失败，请刷新页面或检查后端服务。</div>';
  }
}
loadHistory();

function appendMsg(md, who, shouldScroll = true, isThinking = false) {
  const div = document.createElement('div');
  div.className = 'msg ' + who;
  if (isThinking) {
    div.classList.add('thinking');
    div.innerHTML = md;
  } else {
    div.dataset.pending = true;
    div.dataset.content = md;
    if (window.markedReady) {
      div.innerHTML = md2html(md);
      delete div.dataset.pending;
    } else {
      window.pendingMd = true;
    }
  }
  historyBox.appendChild(div);
  if (shouldScroll) {
    historyBox.scrollTop = historyBox.scrollHeight;
  }
  return div;
}

function resetInputArea() {
  textInput.innerHTML = '';
  $("pick").value = '';
  imageBase64 = null;
  imageLocalURL = null;
  previewImage.src = '';
  previewContainer.style.display = 'none';
  textInput.focus();
}

// 输入框聚焦时自动滚动
textInput.addEventListener('focus', () => {
  setTimeout(() => {
    window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
  }, 300);
});
// 输入框聚焦时自动展开
textInput.addEventListener('focus', () => {
  if (isBarCollapsed) {
    document.getElementById('arrowBtn').click();
  }
});
// 文件选择处理
$("pickBtn").onclick = () => $("pick").click();
$("pick").onchange = e => {
  const f = e.target.files[0];
  if (!f) return;

  // 添加文件大小限制
  const MAX_SIZE = 1024 * 1024 * 1; // 1MB
  if (f.size > MAX_SIZE) {
    alert('图片大小超过限制（1MB），将自动压缩');
    // TODO: 添加压缩逻辑
  }

  const rd = new FileReader();
  rd.onload = ev => {
    imageLocalURL = ev.target.result;
    imageBase64 = imageLocalURL.split(',')[1];
    previewImage.src = imageLocalURL;
    previewContainer.style.display = 'block';
  };
  rd.readAsDataURL(f);
};

// 移除图片
removeImageBtn.onclick = () => {
  imageBase64 = null;
  imageLocalURL = null;
  $("pick").value = '';
  previewImage.src = '';
  previewContainer.style.display = 'none';
  textInput.focus();
};

// 发送消息
$("send").onclick = async () => {
  const txt = textInput.innerText.trim();
  if (!txt && !imageBase64) {
    alert("请输入内容或添加图片/截图");
    return;
  }

  if (currentEventSource && currentEventSource.readyState !== EventSource.CLOSED) {
    alert("请等待当前回复完成后再发送新消息。");
    return;
  }

  const model = $("modelSelect").value;
  const enableSearch = $("enableSearch").checked;
  const userTextToSend = txt;
  const userImageToSend = imageBase64;
  const userImageLocalURL = imageLocalURL;

  let mdUser = '**你：**\n' + userTextToSend;
  appendMsg(mdUser, 'user');
  if (userImageLocalURL) {
    const imgDiv = document.createElement('div');
    imgDiv.className = 'msg user';
    imgDiv.style.padding = '0';
    imgDiv.innerHTML = `<img src="${userImageLocalURL}" alt="用户上传图片" style="max-width:260px; border-radius:6px; margin-top:6px; display: block; margin-left: auto;">`;
    historyBox.appendChild(imgDiv);
    historyBox.scrollTop = historyBox.scrollHeight;
  }

  resetInputArea();
  $("send").disabled = true;
  $("send").textContent = '等待中...';

  try {
    const r = await fetch('/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text: userTextToSend, image: userImageToSend })
    });
    if (!r.ok) {
      const errData = await r.json().catch(() => ({ error: '无法解析错误信息' }));
      throw new Error(`服务器错误: ${r.status} - ${errData.error || '未知错误'}`);
    }
    const js = await r.json();
    if (!js.ok) {
      throw new Error("服务器未能成功处理用户消息");
    }

    const botMsgDiv = appendMsg('**人工智能：**\n<span class="thinking">正在思考...</span>', 'bot', true, true);
    let accumulatedMd = '**人工智能：**\n';
    let isFirstChunk = true;

    const streamUrl = `/stream?model=${encodeURIComponent(model)}&enable_search=${enableSearch}`;
    currentEventSource = new EventSource(streamUrl);

    currentEventSource.onmessage = function(event) {
      try {
        const chunkData = JSON.parse(event.data);
        if (isFirstChunk) {
          botMsgDiv.classList.remove('thinking');
          accumulatedMd = '**人工智能：**\n';
          isFirstChunk = false;
        }
        accumulatedMd += chunkData.text;
        botMsgDiv.innerHTML = md2html(accumulatedMd);
        historyBox.scrollTop = historyBox.scrollHeight;
      } catch (e) {
        console.error("解析 SSE 数据块失败:", e, "数据:", event.data);
        botMsgDiv.innerHTML += "<br>[数据解析错误]";
      }
    };

    currentEventSource.addEventListener('end', function(event) {
      console.log("Stream ended:", event.data);
      closeStream();
    });

    currentEventSource.onerror = function(err) {
      console.error("EventSource failed:", err);
      if (isFirstChunk) {
        botMsgDiv.innerHTML = md2html(accumulatedMd + '\n\n[连接错误或流中断]');
        botMsgDiv.classList.remove('thinking');
      } else {
        botMsgDiv.innerHTML = md2html(accumulatedMd + '\n\n[连接错误或流中断]');
      }
      closeStream();
    };

  } catch (err) {
    console.error("发送消息或连接流失败:", err);
    appendMsg(`**错误：**\n无法发送消息或连接到流服务。\n${err.message}`, 'bot');
    $("send").disabled = false;
    $("send").textContent = '发送';
  }
};

function closeStream() {
  if (currentEventSource) {
    currentEventSource.close();
    currentEventSource = null;
    console.log("EventSource closed.");
  }
  $("send").disabled = false;
  $("send").textContent = '发送';
}

// 新话题处理
$("newTopic").onclick = async () => {
  if (currentEventSource && currentEventSource.readyState !== EventSource.CLOSED) {
    if (!confirm("当前回复仍在进行中，确定要强制开启新话题吗？")) return;
    closeStream();
  } else {
    if (!confirm("确定要开启新话题？这会清空全部对话。")) return;
  }

  try {
    await fetch('/reset', { method: 'POST' });
    historyBox.innerHTML = '';
    resetInputArea();
    console.log("新话题已开启");
  } catch (err) {
    console.error("重置会话失败:", err);
    alert("开启新话题失败，请检查后端服务。");
  }
};

// 图片查看器增强
previewImage.onclick = () => {
  if (imageLocalURL) {
    openViewer(imageLocalURL);
  }
};

historyBox.addEventListener('click', e => {
  if (e.target.tagName === 'IMG') {
    openViewer(e.target.src);
  }
});

$("viewer").onclick = () => $("viewer").style.display = 'none';

function openViewer(src) {
  if (!src || src.startsWith('data:image/png;base64,' + '...')) return;
  const viewer = $("viewer");
  const viewerImg = $("viewerImg");
  viewerImg.src = src;
  viewer.style.display = 'flex';

  // 双击关闭
  viewerImg.ondblclick = () => viewer.style.display = 'none';
};

// 输入处理
textInput.addEventListener("keydown", function(event) {
  if (event.key === "Enter") {
    if (!event.shiftKey) {
      event.preventDefault();
      $("send").click();
    }
  }
});

// 动态填充模型选择
fetch('/models')
  .then(r => r.json())
  .then(models => {
    const select = $("modelSelect");
    models.forEach(model => {
      const option = document.createElement('option');
      option.value = model;
      option.textContent = model;
      select.appendChild(option);
    });
  })
  .catch(err => console.error("加载模型列表失败:", err));
</script>
</body>
</html>
