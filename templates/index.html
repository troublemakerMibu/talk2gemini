<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æœ¬åœ°å¯¹è¯ (æµå¼)</title>
<!-- æ·»åŠ  KaTeX æ”¯æŒ -->
<link rel="stylesheet" href="/static/katex.min.css">
<script src="/static/katex.min.js" defer></script>
<script src="/static/auto-render.min.js" defer></script>

{% raw %}
<style>
/* åŸºç¡€æ ·å¼ */
:root {
--primary-color: #0084ff;
--primary-hover: #0056b3;
--bot-bg: #e6e6e6;
--user-bg: var(--primary-color);
--border-radius: 8px;
--text-color: #333;
--bg-color: #f5f7fa;
}

* {
box-sizing: border-box;
margin: 0;
padding: 0;
}

body {
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', sans-serif;
color: var(--text-color);
background: var(--bg-color);
line-height: 1.5;
min-height: 100vh;
display: flex;
flex-direction: column;
overflow: hidden; /* é˜²æ­¢å‡ºç°æ»šåŠ¨æ¡ */
}

/* å¯¹è¯å†å² */
#history {
flex: 1;
padding: 15px;
overflow-y: auto;
max-height: calc(100vh - 70px); /* è°ƒæ•´é«˜åº¦ï¼Œå‡å°‘ç©ºç™½ */
scroll-behavior: smooth;
padding-bottom: 20px; /* å¢åŠ åº•éƒ¨å†…è¾¹è· */
}

.msg {
max-width: 70%;
padding: 10px 14px;
margin: 8px 0;
border-radius: var(--border-radius);
word-break: break-word;
overflow-wrap: break-word;
overflow: hidden; /* ç¡®ä¿å†…å®¹ä¸æº¢å‡º */
}

/* ç¡®ä¿åˆ—è¡¨é¡¹æ­£ç¡®æ˜¾ç¤º */
.msg ul, .msg ol {
padding-left: 24px; /* å¢åŠ åˆ—è¡¨çš„å·¦å†…è¾¹è· */
margin: 10px 0;
}

.msg li {
margin-bottom: 5px;
}

.user {
background: var(--user-bg);
color: #fff;
margin-left: auto;
}

.bot {
background: var(--bot-bg);
color: #111;
margin-right: auto;
}

.msg img {
max-width: 260px;
border-radius: 6px;
margin-top: 6px;
cursor: pointer;
transition: transform 0.2s;
}

.msg img:hover {
transform: scale(1.02);
}

/* è¾“å…¥åŒº */
#bar {
position: sticky;
bottom: 0;
background: #fff;
border-top: 1px solid #ddd;
display: flex;
align-items: center;
gap: 8px;
padding: 12px 10px;
z-index: 10;
box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
}

#text-input {
flex: 1;
font-size: 16px;
padding: 10px 12px;
border: 1px solid #ccc;
border-radius: var(--border-radius);
min-height: 22px;
max-height: 150px;
overflow-y: auto;
line-height: 1.5;
word-break: break-word;
white-space: pre-wrap;
transition: border-color 0.3s;
}

#text-input:focus {
outline: none;
border-color: var(--primary-color);
}

#text-input:empty::before {
content: attr(placeholder);
color: #aaa;
pointer-events: none;
display: block;
}

button {
padding: 8px 14px;
font-size: 15px;
border-radius: var(--border-radius);
cursor: pointer;
border: none;
transition: background-color 0.2s, transform 0.1s;
}

button:active {
transform: scale(0.98);
}

select {
padding: 8px;
border-radius: 4px;
border: 1px solid #ccc;
}

#send {
background-color: var(--primary-color);
color: white;
font-weight: 500;
}

#send:hover {
background-color: var(--primary-hover);
}

#send:disabled {
background-color: #6c757d;
cursor: not-allowed;
}

#pickBtn, #shotBtn {
background: #f0f0f0;
}

#pickBtn:hover, #shotBtn:hover {
background: #e5e5e5;
}

#newTopic {
margin-left: auto;
background: #f0f0f0;
}

#newTopic:hover {
background: #e5e5e5;
}

/* å›¾ç‰‡é¢„è§ˆ */
#preview-container {
position: relative;
display: none;
margin-left: 6px;
align-self: center;
}

#preview-img {
max-height: 100px;
max-width: 100px;
border: 1px solid #888;
border-radius: 6px;
display: block;
cursor: pointer;
transition: transform 0.2s;
}

#preview-img:hover {
transform: scale(1.05);
}

#remove-image-btn {
position: absolute;
top: -12px;
right: -12px;
background: rgba(220, 53, 69, 0.85);
color: white;
border: 2px solid white;
border-radius: 50%;
width: 28px;
height: 28px;
font-size: 17px;
font-weight: bold;
display: flex;
align-items: center;
justify-content: center;
cursor: pointer;
padding: 0;
box-shadow: 0 2px 4px rgba(0,0,0,0.3);
z-index: 1;
transition: background-color 0.2s, transform 0.15s;
}

#remove-image-btn:hover {
background: rgba(200, 30, 45, 1);
transform: scale(1.1);
}

/* ä»£ç å’ŒçŠ¶æ€ */
pre {
white-space: pre-wrap;
background: #f5f5f5;
padding: 10px;
border-radius: 4px;
overflow-x: auto;
margin: 8px 0;
position: relative; /* æ·»åŠ ç›¸å¯¹å®šä½ */
}

code {
font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
font-size: 0.9em;
}

.thinking {
color: #888;
font-style: italic;
}

/* æ•°å­¦è¡¨è¾¾å¼æ ·å¼å¢å¼º */
.katex-display {
overflow-x: auto;
overflow-y: hidden;
padding: 5px 0;
}

/* æŸ¥çœ‹å™¨ */
#viewer {
display: none;
position: fixed;
left: 0;
top: 0;
width: 100%;
height: 100%;
background: rgba(0, 0, 0, 0.85);
z-index: 999;
align-items: center;
justify-content: center;
backdrop-filter: blur(2px);
transition: opacity 0.3s;
}

#viewerImg {
max-width: 95vw;
max-height: 95vh;
border-radius: 6px;
box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
transform: scale(0.95);
transition: transform 0.3s;
}

#viewer.visible #viewerImg {
transform: scale(1);
}

/* ä¿®æ”¹å¯¼å‡ºæŒ‰é’®æ ·å¼ */
#exportBtn {
position: absolute;
top: 15px;
left: 15px;  /* æ”¹ä¸º left */
background: #28a745;
color: white;
padding: 8px 16px;
border-radius: 6px;
font-size: 14px;
font-weight: 500;
z-index: 100;
box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

#exportBtn:hover {
background: #218838;
}

#exportBtn:disabled {
background: #6c757d;
cursor: not-allowed;
}

/* å¤åˆ¶æŒ‰é’®æ ·å¼ */
.copy-btn {
position: absolute;
background: #4CAF50;
color: white;
border: none;
padding: 4px 8px;
font-size: 12px;
border-radius: 4px;
cursor: pointer;
opacity: 0.8;
transition: opacity 0.2s, background-color 0.2s;
z-index: 10;
}

.copy-btn:hover {
opacity: 1;
background: #45a049;
}

.copy-btn.copied {
background: #2196F3;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
#bar {
flex-wrap: wrap;
padding: 8px;
}

#modelSelect, #text-input {
width: 100%;
}

.msg {
max-width: 85%;
}

#text-input {
order: -1;
margin-bottom: 8px;
}
}


#genImage:disabled + span,
#genImage:disabled {
opacity: .5;
cursor: not-allowed;
}
.genimage-enabled {
color: var(--primary-color);
font-weight: 600;
}
.genimage-checked {
color: #2ecc71;
font-weight: 700;
}
.genimage-checked::before {
content: 'ğŸ–¼ ';
}
</style>
{% endraw %}
<script src="/static/marked.min.js" defer></script>
</head>
<body>
<div id="history"></div>
<button id="exportBtn" title="å¯¼å‡ºå¯¹è¯å†å²">å¯¼å‡º</button>


<div id="bar">
<select id="modelSelect">
{% for model in models %}
<option value="{{ model }}">{{ model }}</option>
{% endfor %}
</select>

<input type="file" accept="image/*" id="pick" style="display:none">
<button id="pickBtn" title="ä»è®¾å¤‡é€‰æ‹©å›¾ç‰‡">é€‰æ‹©å›¾ç‰‡</button>
<button id="shotBtn" title="æ•è·å±å¹•æˆªå›¾">å±å¹•æˆªå›¾</button>

<div id="text-input" contenteditable="true" placeholder="è¾“å…¥å†…å®¹â€¦ï¼ˆShift+Enter æ¢è¡Œ/Enter å‘é€ï¼‰"></div>

<label style="display: flex; align-items: center; gap: 5px;">
<input type="checkbox" id="enableSearch">
è”ç½‘æœç´¢
</label>
<label style="display: flex; align-items: center; gap: 5px;">
<input type="checkbox" id="genImage">ç”Ÿæˆå›¾ç‰‡
</label>
<div id="preview-container">
<img id="preview-img" alt="é¢„è§ˆå›¾ç‰‡">
<button id="remove-image-btn" title="ç§»é™¤å›¾ç‰‡">Ã—</button>
</div>

<button id="send" title="å‘é€æ¶ˆæ¯">å‘é€</button>
<button id="newTopic" title="å¼€å§‹æ–°çš„å¯¹è¯">æ–°è¯é¢˜</button>
</div>

<div id="viewer">
<img id="viewerImg" alt="æŸ¥çœ‹å›¾ç‰‡">
</div>

<script>
// å·¥å…·å‡½æ•°
const $ = id => document.getElementById(id);

// DOM å…ƒç´ å¼•ç”¨
const genImage = $("genImage");
const historyBox = $("history");
const textInput = $("text-input");
const previewContainer = $("preview-container");
const previewImage = $("preview-img");
const removeImageBtn = $("remove-image-btn");
const sendBtn = $("send");
const newTopicBtn = $("newTopic");
const shotBtn = $("shotBtn");
const pickBtn = $("pickBtn");
const modelSelect = $("modelSelect");
const enableSearch = $("enableSearch");
const viewer = $("viewer");
const viewerImg = $("viewerImg");
const exportBtn = $("exportBtn");

// çŠ¶æ€å˜é‡
let imageBase64 = null;
let imageLocalURL = null;
let currentEventSource = null;

// æ¸²æŸ“æ•°å­¦è¡¨è¾¾å¼
function renderMath() {
if (window.renderMathInElement) {
renderMathInElement(document.body, {
delimiters: [
{left: "$$", right: "$$", display: true},
{left: "$", right: "$", display: false}
],
throwOnError: false
});
}
}

// æ·»åŠ å¤åˆ¶æŒ‰é’®åˆ°ä»£ç å—
function addCopyButtons() {
const codeBlocks = document.querySelectorAll('pre');
codeBlocks.forEach((pre, index) => {
// æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰å¤åˆ¶æŒ‰é’®
if (pre.querySelector('.copy-btn')) {
return;
}


// åˆ›å»ºå¤åˆ¶æŒ‰é’®
const copyBtn = document.createElement('button');
copyBtn.className = 'copy-btn';
copyBtn.textContent = 'å¤åˆ¶';
copyBtn.dataset.codeIndex = index;


// è®¾ç½®æŒ‰é’®ä½ç½®çš„å‡½æ•°
const positionButton = () => {
const preRect = pre.getBoundingClientRect();
const scrollHeight = pre.scrollHeight;
const clientHeight = pre.clientHeight;


// åˆ¤æ–­æ˜¯å¦æœ‰æ»šåŠ¨æ¡
if (scrollHeight > clientHeight) {
// æœ‰æ»šåŠ¨æ¡ï¼Œæ”¾åœ¨å³ä¸‹è§’
copyBtn.style.right = '10px';
copyBtn.style.bottom = '10px';
copyBtn.style.top = 'auto';
} else {
// æ— æ»šåŠ¨æ¡ï¼Œæ”¾åœ¨å³ä¸Šè§’
copyBtn.style.right = '10px';
copyBtn.style.top = '10px';
copyBtn.style.bottom = 'auto';
}
};


// åˆå§‹å®šä½
positionButton();


// ç›‘å¬çª—å£å¤§å°å˜åŒ–
window.addEventListener('resize', positionButton);


// å¤åˆ¶åŠŸèƒ½
copyBtn.onclick = async () => {
const codeElement = pre.querySelector('code');
const textToCopy = codeElement ? codeElement.textContent : pre.textContent;


try {
await navigator.clipboard.writeText(textToCopy);
copyBtn.textContent = 'å·²å¤åˆ¶';
copyBtn.classList.add('copied');
setTimeout(() => {
copyBtn.textContent = 'å¤åˆ¶';
copyBtn.classList.remove('copied');
}, 2000);
} catch (err) {
// é™çº§æ–¹æ¡ˆ
const textArea = document.createElement('textarea');
textArea.value = textToCopy;
textArea.style.position = 'absolute';
textArea.style.left = '-9999px';
document.body.appendChild(textArea);
textArea.select();
try {
document.execCommand('copy');
copyBtn.textContent = 'å·²å¤åˆ¶';
copyBtn.classList.add('copied');
setTimeout(() => {
copyBtn.textContent = 'å¤åˆ¶';
copyBtn.classList.remove('copied');
}, 2000);
} catch (err) {
console.error('å¤åˆ¶å¤±è´¥:', err);
alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶');
}
document.body.removeChild(textArea);
}
};

pre.appendChild(copyBtn);
});
}

// Markdown è½¬ HTMLï¼Œå¤„ç†æ¢è¡Œé—®é¢˜
function md2html(txt) {
// ä¿®å¤å¼€å¤´\\\\né—®é¢˜
txt = txt.replace(/^\\\\n+/, '');

if (window.marked) {
marked.setOptions({
gfm: true,
breaks: true,
highlight: function(code, lang) {
return code;
}
});

if (typeof marked.parse === 'function') {
const html = marked.parse(txt);
return html;
}
if (typeof marked === 'function') {
const html = marked(txt);
return html;
}
}

return txt.replace(/&/g, "&amp;")
.replace(/</g, "&lt;")
.replace(/>/g, "&gt;")
.replace(/\\\\n/g, "<br>");
}

// åŠ è½½å†å²è®°å½•
async function loadHistory() {
try {
historyBox.innerHTML = '<div class="msg bot">åŠ è½½å†å²è®°å½•ä¸­...</div>';
const r = await fetch('/history');

if (!r.ok) throw new Error(`HTTP error! status: ${r.status}`);

const arr = await r.json();
historyBox.innerHTML = '';

arr.forEach(obj => {
appendMsg(obj.md, obj.who, false);
});

historyBox.scrollTop = historyBox.scrollHeight;
renderMath(); // æ¸²æŸ“åŠ è½½åçš„æ•°å­¦è¡¨è¾¾å¼
// ä¸ºå·²æœ‰çš„ä»£ç å—æ·»åŠ å¤åˆ¶æŒ‰é’®
setTimeout(addCopyButtons, 100);
} catch (error) {
console.error("åŠ è½½å†å²è®°å½•å¤±è´¥:", error);
historyBox.innerHTML = '<div class="msg bot">åŠ è½½å†å²è®°å½•å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢æˆ–æ£€æŸ¥åç«¯æœåŠ¡ã€‚</div>';
}
}
//åœ¨åˆå§‹åŒ–ä¸æ¨¡å‹é€‰æ‹©å˜åŒ–æ—¶æ§åˆ¶å¯ç”¨çŠ¶æ€ï¼š
function syncGenImageAvailability() {
const ok = modelSelect.value === 'gemini-2.5-flash-image-preview';
genImage.disabled = !ok;
// åˆ‡æ¢â€œå¯ç”¨æ—¶é«˜äº®â€æ ·å¼
const labelSpan = genImage.nextElementSibling;
if (labelSpan) {
labelSpan.classList.toggle('genimage-enabled', ok && !genImage.checked);
labelSpan.classList.toggle('genimage-checked', ok && genImage.checked);
}
}
// åˆå§‹åŠ è½½
document.addEventListener('DOMContentLoaded', function() {
loadHistory();
if (!genImage.nextElementSibling) {
const text = document.createTextNode('ç”Ÿæˆå›¾ç‰‡'); // å…œåº•
const span = document.createElement('span');
// å¦‚æœåŸæ¥å·²ç»æœ‰æ–‡æœ¬èŠ‚ç‚¹ï¼Œæ¬è¿‡å»ï¼›å¦åˆ™ç”¨å…œåº•æ–‡æœ¬
const origText = genImage.parentNode.lastChild;
if (origText && origText.nodeType === Node.TEXT_NODE) {
span.textContent = origText.textContent.trim() || 'ç”Ÿæˆå›¾ç‰‡';
genImage.parentNode.removeChild(origText);
} else {
span.textContent = 'ç”Ÿæˆå›¾ç‰‡';
}
genImage.parentNode.appendChild(span);
}
// è°ƒæ•´é«˜åº¦ä»¥å¡«å……æ•´ä¸ªè§†å›¾
adjustHeight();
window.addEventListener('resize', adjustHeight);
syncGenImageAvailability();
});
modelSelect.addEventListener('change', syncGenImageAvailability);
// è°ƒæ•´é«˜åº¦ï¼Œè§£å†³åº•éƒ¨ç©ºç™½é—®é¢˜
function adjustHeight() {
const windowHeight = window.innerHeight;
const barHeight = $("bar").offsetHeight;
historyBox.style.height = `${windowHeight - barHeight}px`;
historyBox.style.maxHeight = `${windowHeight - barHeight}px`;
}

// æ·»åŠ æ¶ˆæ¯
function appendMsg(md, who, shouldScroll = true, isThinking = false) {
const div = document.createElement('div');
div.className = 'msg ' + who;

if (isThinking) {
div.classList.add('thinking');
div.innerHTML = md;
} else {
// ç§»é™¤å¼€å¤´çš„æ¢è¡Œç¬¦
md = md.replace(/^\\\\n+/, '');
div.innerHTML = md2html(md);

// å»¶è¿Ÿæ¸²æŸ“æ•°å­¦è¡¨è¾¾å¼å’Œæ·»åŠ å¤åˆ¶æŒ‰é’®
setTimeout(() => {
renderMath();
addCopyButtons();
}, 0);
}

historyBox.appendChild(div);

if (shouldScroll) {
setTimeout(() => {
historyBox.scrollTop = historyBox.scrollHeight;
}, 10);
}

return div;
}

// é‡ç½®è¾“å…¥åŒº
function resetInputArea() {
textInput.innerHTML = '';
$("pick").value = '';
imageBase64 = null;
imageLocalURL = null;
previewImage.src = '';
previewContainer.style.display = 'none';
textInput.focus();
}

// å›¾ç‰‡é€‰æ‹©
pickBtn.onclick = () => $("pick").click();

$("pick").onchange = e => {
const file = e.target.files[0];
if (!file) return;

// æ£€æŸ¥æ–‡ä»¶å¤§å°
if (file.size > 18.5 * 1024 * 1024) {
alert("å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡18.5MB");
return;
}

const reader = new FileReader();
reader.onload = ev => {
imageLocalURL = ev.target.result;
imageBase64 = imageLocalURL.split(',')[1];
previewImage.src = imageLocalURL;
previewContainer.style.display = 'block';
};
reader.readAsDataURL(file);
};

// æˆªå›¾åŠŸèƒ½
shotBtn.onclick = async () => {
shotBtn.disabled = true;
shotBtn.textContent = 'æˆªå›¾ä¸­...';

try {
const r = await fetch('/screenshot', {
method: 'POST',
headers: {
'Content-Type': 'application/json'
}
});

const data = await r.json();

if (data.img) {
imageBase64 = data.img;
imageLocalURL = 'data:image/png;base64,' + data.img;
previewImage.src = imageLocalURL;
previewContainer.style.display = 'block';
} else if (r.status !== 500) {
alert("æˆªå›¾å¤±è´¥æˆ–ç”¨æˆ·å–æ¶ˆ");
}
} catch (err) {
console.error("æˆªå›¾è¯·æ±‚å¤±è´¥:", err);
alert("æˆªå›¾åŠŸèƒ½å‡ºé”™");
} finally {
shotBtn.disabled = false;
shotBtn.textContent = 'å±å¹•æˆªå›¾';
}
};

// ç§»é™¤å›¾ç‰‡
removeImageBtn.onclick = () => {
imageBase64 = null;
imageLocalURL = null;
$("pick").value = '';
previewImage.src = '';
previewContainer.style.display = 'none';
textInput.focus();
};

// å‘é€æ¶ˆæ¯
sendBtn.onclick = async () => {
const txt = textInput.innerText.trim();

if (!txt && !imageBase64) {
alert("è¯·è¾“å…¥å†…å®¹æˆ–æ·»åŠ å›¾ç‰‡/æˆªå›¾");
return;
}

if (currentEventSource && currentEventSource.readyState !== EventSource.CLOSED) {
alert("è¯·ç­‰å¾…å½“å‰å›å¤å®Œæˆåå†å‘é€æ–°æ¶ˆæ¯ã€‚");
return;
}
genImage.addEventListener('change', function() {
const ok = !genImage.disabled;
const labelSpan = genImage.nextElementSibling;
if (!labelSpan) return;
labelSpan.classList.toggle('genimage-enabled', ok && !genImage.checked);
labelSpan.classList.toggle('genimage-checked', ok && genImage.checked);
});
const model = modelSelect.value;
const searchEnabled = enableSearch.checked;
const userTextToSend = txt;
const userImageToSend = imageBase64;
const userImageLocalURL = imageLocalURL;

// æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°å¯¹è¯ç•Œé¢
let mdUser = 'ä½ ï¼š\n' + userTextToSend;
appendMsg(mdUser, 'user');

// å¦‚æœæœ‰å›¾ç‰‡ï¼Œä¹Ÿæ·»åŠ åˆ°ç•Œé¢
if (userImageLocalURL) {
const imgDiv = document.createElement('div');
imgDiv.className = 'msg user';
imgDiv.style.padding = '0';
imgDiv.innerHTML = `<img src="${userImageLocalURL}" alt="ç”¨æˆ·ä¸Šä¼ å›¾ç‰‡" style="max-width:260px; border-radius:6px; margin-top:6px; display: block; margin-left: auto;">`;
historyBox.appendChild(imgDiv);
historyBox.scrollTop = historyBox.scrollHeight;
}

resetInputArea();
sendBtn.disabled = true;
sendBtn.textContent = 'ç­‰å¾…ä¸­...';

try {
// å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨
const r = await fetch('/chat', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify({
text: userTextToSend,
image: userImageToSend,
model: model,
enable_search: searchEnabled,
    suppress_base_prompt: !!genImage.checked   // æ–°å¢
})
});

if (!r.ok) {
const errData = await r.json().catch(() => ({ error: 'æ— æ³•è§£æé”™è¯¯ä¿¡æ¯' }));
throw new Error(`æœåŠ¡å™¨é”™è¯¯: ${r.status} - ${errData.error || 'æœªçŸ¥é”™è¯¯'}`);
}

const js = await r.json();

if (!js.ok) {
throw new Error("æœåŠ¡å™¨æœªèƒ½æˆåŠŸå¤„ç†ç”¨æˆ·æ¶ˆæ¯");
}

// åˆ›å»ºç­‰å¾…æç¤º
const botMsgDiv = appendMsg('äººå·¥æ™ºèƒ½ï¼š\n<span class="thinking">æ­£åœ¨æ€è€ƒ...</span>', 'bot', true, true);

let accumulatedMd = 'äººå·¥æ™ºèƒ½ï¼š\n';
let isFirstChunk = true;

// è®¾ç½®æµå¼è¿æ¥
const streamUrl = `/stream?model=${encodeURIComponent(model)}&enable_search=${searchEnabled}`;
currentEventSource = new EventSource(streamUrl);

// æµå¼å¤„ç†
currentEventSource.onmessage = function(event) {
try {
const chunkData = JSON.parse(event.data);

if (isFirstChunk) {
botMsgDiv.classList.remove('thinking');
accumulatedMd = 'äººå·¥æ™ºèƒ½ï¼š\n';
isFirstChunk = false;
}

accumulatedMd += chunkData.text;
botMsgDiv.innerHTML = md2html(accumulatedMd);

// åœ¨æ·»åŠ å†…å®¹åæ¸²æŸ“æ•°å­¦è¡¨è¾¾å¼å’Œæ·»åŠ å¤åˆ¶æŒ‰é’®
renderMath();
addCopyButtons();

historyBox.scrollTop = historyBox.scrollHeight;
} catch (e) {
console.error("è§£æ SSE æ•°æ®å—å¤±è´¥:", e, "æ•°æ®:", event.data);
botMsgDiv.innerHTML += "<br>[æ•°æ®è§£æé”™è¯¯]";
}
};
// å›¾ç‰‡äº‹ä»¶ï¼šæŠŠæ¨¡å‹ç”Ÿæˆçš„å›¾ç‰‡æ’å…¥å½“å‰ AI å›å¤å—
currentEventSource.addEventListener('image', function(event) {
  try {
    const imgData = JSON.parse(event.data); // { mime_type, data }
    if (!imgData || !imgData.data) return;

    const src = `data:${imgData.mime_type || 'image/png'};base64,${imgData.data}`;

    // åœ¨å½“å‰çš„ botMsgDiv å†…éƒ¨è¿½åŠ å›¾ç‰‡
    const imgHtml = `<div><img src="${src}" alt="AI ç”Ÿæˆå›¾ç‰‡" style="max-width:260px; border-radius:6px; margin-top:6px;"></div>`;
    // å¦‚æœè¿˜æ˜¯â€œæ­£åœ¨æ€è€ƒ...â€çŠ¶æ€ï¼Œå…ˆå»æ‰
    botMsgDiv.classList.remove('thinking');
    // ç›´æ¥åœ¨æœ«å°¾è¿½åŠ ï¼Œä¸ç ´åå·²ç´¯ç§¯çš„æ–‡æœ¬
    botMsgDiv.innerHTML = botMsgDiv.innerHTML + imgHtml;

    // æ»šåŠ¨åˆ°åº•éƒ¨
    historyBox.scrollTop = historyBox.scrollHeight;
  } catch (e) {
    console.error("è§£æ image äº‹ä»¶å¤±è´¥:", e, "æ•°æ®:", event.data);
  }
});
// æµç»“æŸå¤„ç†
currentEventSource.addEventListener('end', function(event) {
console.log("Stream ended:", event.data);
closeStream();
// ç¡®ä¿åœ¨æµç»“æŸåå†æ¬¡æ¸²æŸ“æ•°å­¦è¡¨è¾¾å¼å’Œæ·»åŠ å¤åˆ¶æŒ‰é’®
setTimeout(() => {
renderMath();
addCopyButtons();
}, 100);
});

// æµé”™è¯¯å¤„ç†
currentEventSource.onerror = function(err) {
console.error("EventSource failed:", err);

if (isFirstChunk) {
botMsgDiv.innerHTML = md2html(accumulatedMd + '\\\\n\\\\n[è¿æ¥é”™è¯¯æˆ–æµä¸­æ–­]');
botMsgDiv.classList.remove('thinking');
} else {
botMsgDiv.innerHTML = md2html(accumulatedMd + '\\\\n\\\\n[è¿æ¥é”™è¯¯æˆ–æµä¸­æ–­]');
}

// é”™è¯¯æƒ…å†µä¸‹ä¹Ÿå°è¯•æ¸²æŸ“æ•°å­¦è¡¨è¾¾å¼å’Œæ·»åŠ å¤åˆ¶æŒ‰é’®
renderMath();
addCopyButtons();
closeStream();
};
} catch(err) {
console.error("å‘é€æ¶ˆæ¯æˆ–è¿æ¥æµå¤±è´¥:", err);
appendMsg(`**é”™è¯¯ï¼š**\\\\næ— æ³•å‘é€æ¶ˆæ¯æˆ–è¿æ¥åˆ°æµæœåŠ¡ã€‚\\\\n${err.message}`, 'bot');
sendBtn.disabled = false;
sendBtn.textContent = 'å‘é€';
}
};

// å…³é—­æµ
function closeStream() {
if (currentEventSource) {
currentEventSource.close();
currentEventSource = null;
console.log("EventSource closed.");
}

sendBtn.disabled = false;
sendBtn.textContent = 'å‘é€';
}

// ä¿®æ”¹å¯¼å‡ºæŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
exportBtn.onclick = async () => {
try {
// æ£€æŸ¥æ˜¯å¦æœ‰å¯¹è¯å†å²
const historyResponse = await fetch('/history');
const historyData = await historyResponse.json();

if (!historyData || historyData.length === 0) {
alert("å½“å‰æ²¡æœ‰å¯å¯¼å‡ºçš„å¯¹è¯å†å²");
return;
}

exportBtn.disabled = true;
exportBtn.textContent = 'å¯¼å‡ºä¸­...';

// è¯·æ±‚å¯¼å‡º
const response = await fetch('/export');

if (!response.ok) {
throw new Error(`å¯¼å‡ºå¤±è´¥: ${response.status}`);
}

// è·å–æ–‡ä»¶å
const contentDisposition = response.headers.get('Content-Disposition');
let filename = 'å¯¹è¯å†å².html';
if (contentDisposition) {
const matches = /filename="(.+)"/.exec(contentDisposition);
if (matches) {
filename = matches[1];
}
}

// ä¸‹è½½æ–‡ä»¶
const blob = await response.blob();
const url = window.URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = filename;
document.body.appendChild(a);
a.click();
window.URL.revokeObjectURL(url);
document.body.removeChild(a);

console.log('å¯¹è¯å†å²å¯¼å‡ºæˆåŠŸ');
} catch (error) {
console.error('å¯¼å‡ºå¤±è´¥:', error);
alert('å¯¼å‡ºå¯¹è¯å†å²å¤±è´¥: ' + error.message);
} finally {
exportBtn.disabled = false;
exportBtn.textContent = 'å¯¼å‡º';
}
};

// æ–°è¯é¢˜
newTopicBtn.onclick = async () => {
if (currentEventSource && currentEventSource.readyState !== EventSource.CLOSED) {
if (!confirm("å½“å‰å›å¤ä»åœ¨è¿›è¡Œä¸­ï¼Œç¡®å®šè¦å¼ºåˆ¶å¼€å¯æ–°è¯é¢˜å—ï¼Ÿ")) return;
closeStream();
} else {
if (!confirm("ç¡®å®šè¦å¼€å¯æ–°è¯é¢˜ï¼Ÿè¿™ä¼šæ¸…ç©ºå…¨éƒ¨å¯¹è¯ã€‚")) return;
}

try {
await fetch('/reset', { method: 'POST' });
historyBox.innerHTML = '';
resetInputArea();
console.log("æ–°è¯é¢˜å·²å¼€å¯");
} catch (err) {
console.error("é‡ç½®ä¼šè¯å¤±è´¥:", err);
alert("å¼€å¯æ–°è¯é¢˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡ã€‚");
}
};

// é¢„è§ˆå›¾ç‰‡
previewImage.onclick = () => {
if (imageLocalURL) {
openViewer(imageLocalURL);
}
};

// ç‚¹å‡»å†å²æ¶ˆæ¯ä¸­çš„å›¾ç‰‡
historyBox.addEventListener('click', e => {
if (e.target.tagName === 'IMG') {
openViewer(e.target.src);
}
});

// å…³é—­å›¾ç‰‡æŸ¥çœ‹å™¨
viewer.onclick = () => {
viewer.style.opacity = '0';
setTimeout(() => {
viewer.style.display = 'none';
viewer.style.opacity = '1';
}, 300);
};

// æ‰“å¼€å›¾ç‰‡æŸ¥çœ‹å™¨
function openViewer(src) {
if (!src || src.startsWith('data:image/png;base64,' + '...')) return;

viewerImg.src = src;
viewer.style.display = 'flex';
viewer.classList.add('visible');
}

// è¾“å…¥æ¡†å¿«æ·é”®
textInput.addEventListener("keydown", function(event) {
if (event.key === "Enter") {
if (!event.shiftKey) {
event.preventDefault();
sendBtn.click();
}
}
});

// è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
textInput.addEventListener('input', function() {
// å¯ä»¥æ·»åŠ è‡ªåŠ¨é«˜åº¦è°ƒæ•´é€»è¾‘
});

</script>
</body>
</html>
