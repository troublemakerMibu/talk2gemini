<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<title>本地对话 (流式)</title>
{% raw %}
<style>
/* ... body, #history, .msg, .user, .bot, .msg img ... (基本不变) */
body{margin:0;padding-bottom:140px;font-family:Arial,Helvetica,sans-serif;background:#f5f7fa;}
#history{padding:15px;overflow-y:auto;max-height:calc(100vh - 140px);}
.msg{max-width:70%;padding:10px 14px;margin:8px 0;border-radius:8px;line-height:1.55;word-break:break-word;}
.user{background:#0084ff;color:#fff;margin-left:auto;}
.bot {background:#e6e6e6;color:#111;margin-right:auto;}
.msg img{max-width:260px;border-radius:6px;margin-top:6px;}

#bar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #fff;
  border-top: 1px solid #ddd;
  display: flex;
  align-items: center; /* 确保所有子元素在垂直方向上居中 */
  gap: 8px;
  padding: 10px 8px;
  z-index: 10;
  min-height: 42px;
}

#text-input {
  flex: 1;
  font-size: 16px;
  padding: 8px 10px;
  border: 1px solid #ccc;
  border-radius: 6px;
  min-height: 22px; /* 与按钮的默认高度接近 */
  max-height: 100px;
  overflow-y: auto;
  line-height: 1.5;
  word-break: break-word;
  white-space: pre-wrap;
}

#text-input:empty::before {
  content: attr(placeholder);
  color: #aaa;
  pointer-events: none;
  display: block;
}

#send {
  padding: 8px 14px;
  font-size: 15px;
  background-color: #007bff;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: background-color 0.2s ease;
  /* align-self: stretch; */ /* 已移除此行，使其垂直居中 */
}
#send:hover {
  background-color: #0056b3;
}
#send:disabled {
  background-color: #6c757d;
  cursor: not-allowed;
}

#bar button{padding:8px 14px;font-size:15px; border-radius: 6px;}
#newTopic {
    margin-left:auto;
    background:#f0f0f0;
    /* align-self: stretch; */ /* 已移除此行，使其垂直居中 */
}


/* 图片预览容器和移除按钮样式 */
#preview-container {
    position: relative;
    display: none;
    margin-left: 6px;
    align-self: center; /* 保持不变，确保容器在 #bar 中垂直居中 */
}

#preview-img {
    max-height: 100px; /* 您可以根据需要调整预览图的最大高度 */
    max-width: 100px;  /* 您可以根据需要调整预览图的最大宽度 */
    border: 1px solid #888;
    border-radius: 6px;
    display: block;
    cursor: pointer;
}

#remove-image-btn {
    position: absolute;
    top: -12px; /* 调整Y轴位置，使其更适合较大的按钮 */
    right: -12px; /* 调整X轴位置，使其更适合较大的按钮 */
    background: rgba(220, 53, 69, 0.85); /* 使用稍深且略带透明的红色 */
    color: white;
    border: 2px solid white; /* 增加边框宽度，使其在图片上更突出 */
    border-radius: 50%; /* 保持圆形 */
    width: 28px; /* 增大按钮宽度 */
    height: 28px; /* 增大按钮高度 */
    font-size: 17px; /* 增大字体大小，使 "×" 更清晰 */
    font-weight: bold;
    display: flex; /* 使用 flex 布局进行内容居中 */
    align-items: center; /* 垂直居中 */
    justify-content: center; /* 水平居中 */
    cursor: pointer;
    padding: 0; /* 移除内边距，因为大小由width/height控制 */
    box-shadow: 0 2px 4px rgba(0,0,0,0.3); /* 更新阴影效果，使其更柔和 */
    z-index: 1; /* 确保按钮在图片上层 */
    transition: background-color 0.2s ease, transform 0.15s ease; /* 添加平滑过渡效果 */
}

#remove-image-btn:hover {
    background: rgba(200, 30, 45, 1); /* 悬停时背景更深，不透明 */
    transform: scale(1.1); /* 悬停时轻微放大，提供反馈 */
}


pre{white-space:pre-wrap;}
.thinking {
   color: #888;
   font-style: italic;
}
</style>
{% endraw %}

  <script src="/static/marked.min.js"></script>
<script>
function md2html(txt){
  if (window.marked){
     marked.setOptions({
         gfm: true,
         breaks: true,
     });
     if (typeof marked.parse==='function') return marked.parse(txt);
     if (typeof marked     ==='function') return marked(txt);
  }
  return txt.replace(/&/g,"&amp;")
         .replace(/</g,"&lt;")
         .replace(/>/g,"&gt;")
         .replace(/\n/g,"<br>");
}
</script>
</head>
<body>
<div id="history"></div>
<div id="bar">
  <select id="modelSelect">
    {% for model in models %}
      <option value="{{ model }}">{{ model }}</option>
    {% endfor %}
  </select>
  <input type="file" accept="image/*" id="pick" style="display:none">
  <button id="pickBtn">选择图片</button>
  <button id="shotBtn">屏幕截图</button>
  <div id="text-input" contenteditable="true" placeholder="输入内容…（Shift+Enter 换行/Enter 发送）"></div>
  <label style="display: flex; align-items: center; gap: 5px;">
  <input type="checkbox" id="enableSearch" />
  联网搜索
  </label>
  <div id="preview-container">
    <img id="preview-img">
    <button id="remove-image-btn" title="移除图片">&times;</button>
  </div>
  <button id="send">发送</button>
  <button id="newTopic">新话题</button>
</div>

<div id="viewer" style="display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:999;
                       align-items:center;justify-content:center;">
  <img id="viewerImg" style="max-width:95vw;max-height:95vh;border-radius:6px;box-shadow:0 0 12px #000">
</div>
<script>
const $ = id => document.getElementById(id);
const historyBox      = $("history");
const textInput       = $("text-input");
const previewContainer = $("preview-container");
const previewImage    = $("preview-img");
const removeImageBtn  = $("remove-image-btn");

let imageBase64   = null;
let imageLocalURL = null;
let currentEventSource = null;

async function loadHistory(){
  try {
    const r   = await fetch('/history');
    if (!r.ok) throw new Error(`HTTP error! status: ${r.status}`);
    const arr = await r.json();
    historyBox.innerHTML = '';
    arr.forEach(obj=>{
        appendMsg(obj.md, obj.who, false);
    });
    historyBox.scrollTop = historyBox.scrollHeight;
  } catch (error) {
      console.error("加载历史记录失败:", error);
      historyBox.innerHTML = '<div class="msg bot">加载历史记录失败，请刷新页面或检查后端服务。</div>';
  }
}
loadHistory();

function appendMsg(md, who, shouldScroll = true, isThinking = false) {
  const div = document.createElement('div');
  div.className = 'msg ' + who;
  if (isThinking) {
     div.classList.add('thinking');
     div.innerHTML = md;
  } else {
     div.innerHTML = md2html(md);
  }
  historyBox.appendChild(div);
  if (shouldScroll) {
     historyBox.scrollTop = historyBox.scrollHeight;
  }
  return div;
}

function resetInputArea(){
  textInput.innerHTML = '';
  $("pick").value = '';
  imageBase64   = null;
  imageLocalURL = null;
  previewImage.src = '';
  previewContainer.style.display='none';
  textInput.focus();
}

$("pickBtn").onclick = ()=> $("pick").click();
$("pick").onchange   = e=>{
    const f = e.target.files[0]; if(!f) return;
    const rd = new FileReader();
    rd.onload = ev=>{
        imageLocalURL = ev.target.result;
        imageBase64   = imageLocalURL.split(',')[1];
        previewImage.src = imageLocalURL;
        previewContainer.style.display='block';
    };
    rd.readAsDataURL(f);
};

$("shotBtn").onclick = async ()=>{
    $("shotBtn").disabled = true;
    $("shotBtn").textContent = '截图中...';
    try {
        const r  = await fetch('/screenshot',{method:'POST'});
        const js = await r.json();
        if(js.img){
            imageBase64   = js.img;
            imageLocalURL = 'data:image/png;base64,'+js.img;
            previewImage.src = imageLocalURL;
            previewContainer.style.display='block';
        } else if (r.status !== 500) {
            alert("截图失败或用户取消");
        }
    } catch (err) {
        console.error("截图请求失败:", err);
        alert("截图功能出错");
    } finally {
        $("shotBtn").disabled = false;
        $("shotBtn").textContent = '屏幕截图';
    }
};

removeImageBtn.onclick = () => {
    imageBase64 = null;
    imageLocalURL = null;
    $("pick").value = '';
    previewImage.src = '';
    previewContainer.style.display = 'none';
    textInput.focus();
};

$("send").onclick = async ()=>{
    const txt = textInput.innerText.trim();
    if(!txt && !imageBase64){
        alert("请输入内容或添加图片/截图");
        return;
    }

    if (currentEventSource && currentEventSource.readyState !== EventSource.CLOSED) {
        alert("请等待当前回复完成后再发送新消息。");
        return;
    }

    const model = $("modelSelect").value;
    const enableSearch = $("enableSearch").checked;
    const userTextToSend = txt;
    const userImageToSend = imageBase64;
    const userImageLocalURL = imageLocalURL;

    let mdUser = '**你：**\n' + userTextToSend;
    appendMsg(mdUser,'user');
    if(userImageLocalURL){
        const imgDiv = document.createElement('div');
        imgDiv.className = 'msg user';
        imgDiv.style.padding = '0';
        imgDiv.innerHTML = `<img src="${userImageLocalURL}" alt="用户上传图片" style="max-width:260px; border-radius:6px; margin-top:6px; display: block; margin-left: auto;">`;
        historyBox.appendChild(imgDiv);
        historyBox.scrollTop = historyBox.scrollHeight;
    }

    resetInputArea();
    $("send").disabled = true;
    $("send").textContent = '等待中...';

    try {
        const r = await fetch('/chat', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({text: userTextToSend, image: userImageToSend})
        });
        if (!r.ok) {
            const errData = await r.json().catch(() => ({error: '无法解析错误信息'}));
            throw new Error(`服务器错误: ${r.status} - ${errData.error || '未知错误'}`);
        }
        const js = await r.json();
        if (!js.ok) {
            throw new Error("服务器未能成功处理用户消息");
        }

        const botMsgDiv = appendMsg('**人工智能：**\n<span class="thinking">正在思考...</span>', 'bot', true, true);
        let accumulatedMd = '**人工智能：**\n';
        let isFirstChunk = true;

        const streamUrl = `/stream?model=${encodeURIComponent(model)}&enable_search=${enableSearch}`;
        currentEventSource = new EventSource(streamUrl);

        currentEventSource.onmessage = function(event) {
            try {
                const chunkData = JSON.parse(event.data);
                if (isFirstChunk) {
                    botMsgDiv.classList.remove('thinking');
                    accumulatedMd = '**人工智能：**\n';
                    isFirstChunk = false;
                }
                accumulatedMd += chunkData.text;
                botMsgDiv.innerHTML = md2html(accumulatedMd);
                historyBox.scrollTop = historyBox.scrollHeight;
            } catch (e) {
                console.error("解析 SSE 数据块失败:", e, "数据:", event.data);
                botMsgDiv.innerHTML += "<br>[数据解析错误]";
            }
        };

        currentEventSource.addEventListener('end', function(event) {
            console.log("Stream ended:", event.data);
            closeStream();
        });

        currentEventSource.onerror = function(err) {
            console.error("EventSource failed:", err);
            if (isFirstChunk) {
                botMsgDiv.innerHTML = md2html(accumulatedMd + '\n\n[连接错误或流中断]');
                botMsgDiv.classList.remove('thinking');
            } else {
                botMsgDiv.innerHTML = md2html(accumulatedMd + '\n\n[连接错误或流中断]');
            }
            closeStream();
        };

    } catch(err) {
        console.error("发送消息或连接流失败:", err);
        appendMsg(`**错误：**\n无法发送消息或连接到流服务。\n${err.message}`, 'bot');
        $("send").disabled = false;
        $("send").textContent = '发送';
    }
};

function closeStream() {
    if (currentEventSource) {
        currentEventSource.close();
        currentEventSource = null;
        console.log("EventSource closed.");
    }
    $("send").disabled = false;
    $("send").textContent = '发送';
}

$("newTopic").onclick = async ()=>{
    if (currentEventSource && currentEventSource.readyState !== EventSource.CLOSED) {
        if (!confirm("当前回复仍在进行中，确定要强制开启新话题吗？")) return;
        closeStream();
    } else {
        if (!confirm("确定要开启新话题？这会清空全部对话。")) return;
    }

    try {
        await fetch('/reset',{method:'POST'});
        historyBox.innerHTML='';
        resetInputArea();
        console.log("新话题已开启");
    } catch (err) {
        console.error("重置会话失败:", err);
        alert("开启新话题失败，请检查后端服务。");
    }
};

previewImage.onclick = ()=> {
    if(imageLocalURL) {
        openViewer(imageLocalURL);
    }
};
historyBox.addEventListener('click',e=>{
    if(e.target.tagName==='IMG'){
        openViewer(e.target.src);
    }
});
$("viewer").onclick = ()=> $("viewer").style.display='none';

function openViewer(src){
    if(!src || src.startsWith('data:image/png;base64,' + '...')) return;
    $("viewerImg").src = src;
    $("viewer").style.display='flex';
}

textInput.addEventListener("keydown", function(event) {
  if (event.key === "Enter") {
    if (!event.shiftKey) {
      event.preventDefault();
      $("send").click();
    }
  }
});

textInput.addEventListener('input', function() {
});

</script>
</body>
</html>